# Casos de Uso del Sistema

## **CU-001: Registro de Usuario**

**Actor Principal:** Usuario no registrado
**Precondición:** El usuario no tiene cuenta
**Postcondición:** Usuario registrado y sesión iniciada

### **Flujo Principal**

1. El usuario accede a la página de registro.
2. El sistema muestra el formulario (nombre, apellido, email, contraseña, teléfono).
3. El usuario completa el formulario.
4. El sistema valida:

   * Email con formato válido.
   * Email no registrado en la BD.
   * Contraseña válida (mínimo 8 caracteres, 1 mayúscula, 1 número).
   * Teléfono con formato válido.
5. El sistema hashea la contraseña.
6. El sistema guarda el usuario en la base de datos.
7. El sistema envía email de confirmación.
8. El sistema inicia sesión automáticamente.
9. El sistema redirige a la página principal.

### **Flujos Alternativos**

**4a. Email ya existe:**

* El sistema muestra: *"Este email ya está registrado"*.
* Ofrece ir a *Iniciar Sesión*.

**4b. Contraseña débil:**

* El sistema muestra los requisitos no cumplidos.
* El usuario corrige y reintenta.

---

## **CU-002: Buscar Producto**

**Actor Principal:** Usuario
**Precondición:** El usuario está en la página principal
**Postcondición:** Se muestran los resultados de búsqueda

### **Flujo Principal**

1. El usuario ingresa términos en la barra de búsqueda.
2. Presiona Enter o clic en “Buscar”.
3. El sistema busca en:

   * Nombre
   * Descripción
   * Marca
   * Categoría
   * Especificaciones
4. El sistema muestra resultados ordenados por relevancia.
5. El sistema muestra la cantidad de resultados.
6. El sistema permite aplicar filtros adicionales.

### **Flujos Alternativos**

**4a. Sin resultados:**

* El sistema muestra: *"No se encontraron productos"*.
* Sugiere productos relacionados o populares.

**6a. Usuario aplica filtros:**

* El sistema actualiza resultados en tiempo real.

---

## **CU-003: Agregar Producto al Carrito**

**Actor Principal:** Usuario
**Precondición:** El usuario está viendo el detalle del producto
**Postcondición:** Producto agregado al carrito

### **Flujo Principal**

1. El usuario selecciona cantidad (default = 1).
2. Hace clic en “Agregar al Carrito”.
3. El sistema valida stock disponible.
4. El sistema obtiene o crea el carrito del usuario.
5. El sistema verifica si el producto ya está en el carrito:

   * Si existe → Suma cantidades.
   * Si no → Agrega nuevo ítem.
6. El sistema muestra “Producto agregado al carrito”.
7. Actualiza el contador del carrito.
8. Muestra opciones: "Ver Carrito" o "Seguir Comprando".

### **Flujos Alternativos**

**3a. Stock insuficiente:**

* El sistema muestra: *"Solo quedan X unidades disponibles"*.
* Ajusta cantidad máxima.

**5a. Producto ya en carrito:**

* El sistema pregunta: *"¿Actualizar cantidad?"*.
* Usuario confirma y se actualiza.

---

## **CU-004: Aplicar Cupón de Descuento**

**Actor Principal:** Cliente
**Precondición:** Carrito o checkout con productos
**Postcondición:** Descuento aplicado

### **Flujo Principal**

1. Cliente hace clic en “¿Tienes un cupón?”.
2. El sistema muestra el campo de entrada.
3. Cliente ingresa código.
4. Hace clic en “Aplicar”.
5. El sistema valida:

   * Código existe.
   * Cupón activo.
   * Fecha válida.
   * No excedió usos máximos.
   * Cliente no excedió su límite.
   * Compra cumple monto mínimo.
6. El sistema calcula descuento.
7. Actualiza total.
8. Muestra: *"Ahorraste S/ XX.XX"*.

### **Flujos Alternativos**

**5a. Cupón inválido:** Error específico.
**5b. No cumple monto mínimo:** *"Agrega S/ XX.XX más..."*.
**5c. Cupón ya usado:** *"Ya usaste este cupón"*.
**8a. Remover cupón:** Recalcula total sin descuento.

---

## **CU-005: Realizar Compra (Checkout)**

**Actor Principal:** Cliente autenticado
**Precondición:** Carrito con productos
**Postcondición:** Pedido creado y pago procesado

### **Flujo Principal**

1. Cliente hace clic en “Proceder al Checkout”.
2. El sistema valida stock.
3. El sistema muestra resumen del pedido (productos, subtotal, descuentos, envío, total).
4. Cliente selecciona/agrega dirección.
5. El sistema calcula costo de envío.
6. Cliente selecciona método de pago.
7. Cliente ingresa datos (tokenizados con Stripe).
8. Revisa resumen final.
9. Hace clic en “Confirmar Pedido”.
10. El sistema inicia transacción.
11. Verifica stock nuevamente (CRITICAL).
12. Crea registro de Venta.
13. Crea Detalle_Venta.
14. Procesa pago con Stripe.
15. Stripe confirma pago.
16. Actualiza estado_pago = pagado.
17. Descuenta stock.
18. Registra movimientos de inventario.
19. Marca carrito como “convertido”.
20. Genera número de pedido.
21. Hace COMMIT.
22. Envía email de confirmación.
23. Redirige a “Pedido Confirmado”.

### **Flujos Alternativos**

**2a. Producto sin stock:**

* Muestra error y bloquea continuar.

**12a. Stock cambia durante checkout:**

* Muestra advertencia.
* Ajusta cantidades.
* Cliente debe confirmar.

**16a. Pago fallido:**

* ROLLBACK.
* Muestra error.
* Permite reintentar.

**16b. Pago pendiente:**

* Crea pedido “pendiente_pago”.
* Envia instrucciones.

---

## **CU-006: Ver Historial de Pedidos**

**Actor Principal:** Cliente
**Precondición:** Cliente autenticado
**Postcondición:** Historial mostrado

### **Flujo Principal**

1. Cliente accede a “Mis Pedidos”.
2. El sistema obtiene pedidos.
3. Muestra lista con número, fecha, estado, total y “Ver Detalle”.
4. Cliente selecciona “Ver Detalle”.
5. El sistema muestra:

   * Productos, cantidades y precios
   * Dirección
   * Método de pago
   * Timeline de estados
   * Tracking
   * “Descargar factura”
   * “Solicitar devolución”

### **Flujos Alternativos**

**2a. Sin pedidos:**

* Muestra: *"Aún no has realizado compras"*.
* Botón: “Explorar Productos”.

---

## **CU-007: Cancelar Pedido**

**Actor Principal:** Cliente
**Precondición:** Pedido en estado confirmado o procesando
**Postcondición:** Pedido cancelado y reembolso iniciado

### **Flujo Principal**

1. Cliente accede al detalle del pedido.
2. El sistema verifica estado.
3. Muestra “Cancelar Pedido”.
4. Cliente hace clic.
5. Confirmación de cancelación.
6. Cliente selecciona motivo (opcional).
7. Cliente confirma.
8. Sistema cambia estado a “cancelado”.
9. Inicia reembolso.
10. Devuelve stock.
11. Registra movimientos.
12. Envía email.
13. Muestra: *"Reembolso procesado en 3-5 días"*.

### **Flujos Alternativos**

**2a. Pedido enviado:**

* No aparece “Cancelar”.
* Muestra contacto soporte.

**9a. Pago contra reembolso:**

* Solo cancela.
* Sin reembolso.

---

## **CU-008: Gestionar Inventario (Admin)**

**Actor Principal:** Administrador
**Precondición:** Admin autenticado
**Postcondición:** Inventario actualizado

### **Flujo Principal**

1. Admin accede a “Gestión de Inventario”.
2. El sistema muestra lista con stock, stock mínimo y alertas.
3. Admin busca producto por nombre/SKU.
4. Hace clic en “Ajustar Inventario”.
5. El sistema muestra formulario (tipo de movimiento, cantidad, motivo, lote).
6. Admin llena formulario.
7. El sistema valida cantidad positiva.
8. Actualiza cantidad_disponible.
9. Registra movimiento.
10. Muestra confirmación.
11. Si stock < mínimo → muestra alerta.

### **Flujos Alternativos**

**6a. Ajuste negativo excede stock:**

* Muestra error.

**11a. Stock = 0:**

* Marca producto como “agotado”.
* Notifica admins.

---

## **CU-009: Procesar Reembolso (Admin)**

**Actor Principal:** Administrador
**Precondición:** Cliente solicitó devolución
**Postcondición:** Reembolso procesado

### **Flujo Principal**

1. Admin accede a “Solicitudes de Devolución”.
2. El sistema muestra solicitudes pendientes.
3. Admin selecciona una.
4. El sistema muestra detalles, motivo, productos, monto.
5. Admin hace clic en “Aprobar Reembolso”.
6. Confirmación.
7. Admin confirma.
8. El sistema marca como “procesando”.
9. Procesa reembolso con proveedor.
10. Proveedor confirma.
11. Actualiza estado a “completado”.
12. Actualiza estado_pago a “reembolsado”.
13. Si es total → devuelve stock.
14. Envía email.
15. Muestra confirmación.

### **Flujos Alternativos**

**5a. Admin rechaza:**

* Solicita motivo.
* Estado = rechazado.
* Notifica cliente.

**10a. Reembolso falla:**

* Registra error.
* Notifica admin para manejo manual.

---

## **CU-010: Valorar Producto**

**Actor Principal:** Cliente
**Precondición:** Cliente compró el producto
**Postcondición:** Valoración registrada

### **Flujo Principal**

1. Cliente va a “Mis Pedidos”.
2. El sistema muestra pedidos entregados.
3. Aparece botón “Valorar”.
4. Cliente hace clic.
5. El sistema muestra formulario (estrellas 1–5, título, comentario, fotos).
6. Cliente completa formulario.
7. Hace clic en “Enviar Valoración”.
8. El sistema valida:

   * Cliente no valoró antes.
   * Calificación entre 1 y 5.
9. El sistema guarda valoración.
10. Recalcula promedio.
11. Incrementa total valoraciones.
12. Marca como “compra verificada”.
13. Muestra mensaje final.

### **Flujos Alternativos**

**8a. Cliente ya valoró:**

* Muestra valoración anterior.
* Permite editar.

**9a. Requiere moderación:**

* Marca “pendiente_aprobacion”.
* Admin revisa antes de publicar.

---