# Configuración del Entorno

## Requisitos Previos

### Requisitos de Hardware

| **Componente** | **Mínimo** | **Recomendado** |
|----------------|------------|-----------------|
| **CPU** | Dual-core 2.0 GHz | Quad-core 3.0 GHz |
| **RAM** | 8 GB | 16 GB |
| **Disco** | 20 GB disponibles | 50 GB SSD |
| **Internet** | 10 Mbps | 50 Mbps |

### Requisitos de Software

| **Software** | **Versión Mínima** | **Propósito** |
|--------------|-------------------|---------------|
| **Sistema Operativo** | Linux (Ubuntu 22.04), macOS 12+, Windows 10+ con WSL2 | Plataforma base |
| **Git** | 2.30+ | Control de versiones |
| **Docker** | 24.0+ | Containerización |
| **Docker Compose** | 2.20+ | Orquestación de contenedores |
| **Node.js** | 20.x LTS | Runtime para frontend |
| **Rust** | 1.75+ | Lenguaje para backend |
| **PostgreSQL** | 16+ | Base de datos (via Docker) |
| **Redis** | 7+ | Cache (via Docker) |
| **Editor de Código** | VS Code, Cursor, Zed | IDE recomendado |

---

## Instalación de Herramientas

### Instalación de Git

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install git -y
git --version
```

#### macOS
```bash
# Usando Homebrew
brew install git
git --version
```

#### Windows
1. Descargar desde [git-scm.com](https://git-scm.com/download/win)
2. Ejecutar el instalador
3. Verificar en PowerShell:
```powershell
git --version
```

---

### Instalación de Docker y Docker Compose

#### Linux (Ubuntu)
```bash
# Desinstalar versiones antiguas
sudo apt-get remove docker docker-engine docker.io containerd runc

# Instalar dependencias
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg lsb-release

# Agregar clave GPG oficial de Docker
sudo mkdir -m 0755 -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# Configurar repositorio
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Instalar Docker Engine
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Agregar usuario al grupo docker (evitar usar sudo)
sudo usermod -aG docker $USER
newgrp docker

# Verificar instalación
docker --version
docker compose version
```

#### macOS
```bash
# Descargar Docker Desktop desde
# https://www.docker.com/products/docker-desktop

# O usando Homebrew
brew install --cask docker

# Iniciar Docker Desktop desde Applications

# Verificar
docker --version
docker compose version
```

#### Windows
1. Instalar WSL2: [Guía oficial de Microsoft](https://docs.microsoft.com/en-us/windows/wsl/install)
2. Descargar Docker Desktop: [docker.com](https://www.docker.com/products/docker-desktop)
3. Instalar y reiniciar
4. Verificar en PowerShell:
```powershell
docker --version
docker compose version
```

---

### Instalación de Node.js y npm

#### Linux (Ubuntu)
```bash
# Usando NodeSource (recomendado)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verificar instalación
node --version  # v20.x.x
npm --version   # 10.x.x
```

#### macOS
```bash
# Usando Homebrew
brew install node@20

# Verificar
node --version
npm --version
```

#### Windows
1. Descargar desde [nodejs.org](https://nodejs.org/) (versión 20.x LTS)
2. Ejecutar instalador
3. Verificar en PowerShell:
```powershell
node --version
npm --version
```

---

### Instalación de Rust

#### Linux / macOS
```bash
# Instalar rustup (gestor de versiones de Rust)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Seleccionar instalación por defecto (opción 1)

# Configurar PATH en la sesión actual
source "$HOME/.cargo/env"

# Verificar instalación
rustc --version  # rustc 1.75+
cargo --version  # cargo 1.75+

# Instalar herramientas adicionales
rustup component add rustfmt clippy
cargo install cargo-watch  # Para hot-reload en desarrollo
```

#### Windows
1. Descargar rustup desde [rustup.rs](https://rustup.rs/)
2. Ejecutar `rustup-init.exe`
3. Seguir instrucciones del instalador
4. Verificar en PowerShell:
```powershell
rustc --version
cargo --version
```

---

### Instalación de Herramientas Adicionales

#### **sqlx-cli (para migraciones de PostgreSQL)**
```bash
cargo install sqlx-cli --no-default-features --features postgres
```

#### **pnpm (gestor de paquetes alternativo, opcional)**
```bash
npm install -g pnpm
pnpm --version
```

---

## Configuración del Proyecto

### Clonar el Repositorio

```bash
# Clonar el repositorio
git clone https://github.com/tu-usuario/KronosTech.git
cd KronosTech

# Verificar estructura
ls -la
```

**Estructura esperada:**
```
KronosTech/
├── backend/           # API en Rust
├── frontend/          # Cliente en SvelteKit
├── documentacion/
└── README.md
```

---

### Configurar Ramas de Git

```bash
# Crear rama de desarrollo personal
git checkout -b dev/tu-nombre

# Configurar upstream
git remote add upstream https://github.com/organizacion/KronosTech.git

# Verificar remotes
git remote -v
```

---

## Configuración de Base de Datos

### Iniciar PostgreSQL con Docker

```bash
# Crear red de Docker
docker network create ecommerce-network

# Iniciar PostgreSQL
docker run -d \
  --name ecommerce-postgres \
  --network ecommerce-network \
  -e POSTGRES_DB=ecommerce_db \
  -e POSTGRES_USER=ecommerce \
  -e POSTGRES_PASSWORD=dev_password_123 \
  -p 5432:5432 \
  -v postgres-data:/var/lib/postgresql/data \
  postgres:16-alpine

# Verificar que está corriendo
docker ps | grep postgres
```

---

### Crear Base de Datos y Ejecutar Migraciones

```bash
# Conectarse a PostgreSQL
docker exec -it ecommerce-postgres psql -U ecommerce -d ecommerce_db

# Dentro de psql, verificar conexión
\l  # Listar bases de datos
\q  # Salir

# Ejecutar script inicial
docker exec -i ecommerce-postgres psql -U ecommerce -d ecommerce_db < database/init.sql

# Ejecutar migraciones
cd backend
sqlx migrate run --database-url "postgres://ecommerce:dev_password_123@localhost:5432/ecommerce_db"
```

---

### Insertar Datos de Prueba (Seeds)

```bash
# Ejecutar seeds desde archivos SQL
docker exec -i ecommerce-postgres psql -U ecommerce -d ecommerce_db < database/seeds/001_seed_categories.sql
docker exec -i ecommerce-postgres psql -U ecommerce -d ecommerce_db < database/seeds/002_seed_products.sql

# O ejecutar todos los seeds de una vez
for file in database/seeds/*.sql; do
  docker exec -i ecommerce-postgres psql -U ecommerce -d ecommerce_db < "$file"
done
```

---

### Verificar Datos

```bash
# Conectarse a la base de datos
docker exec -it ecommerce-postgres psql -U ecommerce -d ecommerce_db

# Dentro de psql
SELECT COUNT(*) FROM producto_detalle;  -- Debe mostrar productos insertados
SELECT * FROM familia;                  -- Ver familias
SELECT * FROM categoria LIMIT 5;        -- Ver categorías
\dt                                      -- Listar todas las tablas
\q                                       -- Salir
```

---

## Configuración del Backend

### Configurar Variables de Entorno

```bash
cd backend

# Copiar archivo de ejemplo
cp .env.example .env

# Editar archivo .env
nano .env  # o vim, code, etc.
```

**Contenido del archivo `.env`:**
```bash
# ===================
# DATABASE
# ===================
DATABASE_URL=postgres://ecommerce:dev_password_123@localhost:5432/ecommerce_db
DATABASE_MAX_CONNECTIONS=20

# ===================
# REDIS
# ===================
REDIS_URL=redis://localhost:6379
REDIS_POOL_SIZE=10

# ===================
# JWT
# ===================
JWT_SECRET=super_secret_dev_key_change_in_production_123456789
JWT_EXPIRATION=900
REFRESH_TOKEN_EXPIRATION=604800

# ===================
# STRIPE
# ===================
STRIPE_SECRET_KEY=sk_test_your_test_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_test_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here

# ===================
# EMAIL
# ===================
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu-email@gmail.com
SMTP_PASSWORD=tu-app-password
EMAIL_FROM=noreply@tutienda.com

# ===================
# STORAGE
# ===================
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=ecommerce-assets
S3_REGION=us-east-1

# ===================
# APPLICATION
# ===================
APP_ENV=development
APP_PORT=8080
APP_HOST=0.0.0.0
LOG_LEVEL=debug
CORS_ORIGINS=http://localhost:5173,http://localhost:5174
```

---

### Instalar Dependencias

```bash
# Dentro del directorio backend/
cargo build

# Esto puede tomar varios minutos la primera vez
# Se descargarán y compilarán todas las dependencias
```

---

### Ejecutar Backend en Desarrollo

```bash
# Con hot-reload usando cargo-watch
cargo watch -x run

# O sin hot-reload
cargo run

# Verificar que está corriendo
# Deberías ver en la terminal:
# Server running on http://0.0.0.0:8080
```

---

### Probar Endpoints

```bash
# Health check
curl http://localhost:8080/health

# Debería responder:
# {"status":"ok"}

# Listar productos
curl http://localhost:8080/api/productos | jq

# Ver documentación de API (si está configurada Swagger)
# http://localhost:8080/api/docs
```

---

## Configuración del Frontend

### Configurar Frontend Cliente

```bash
cd frontend

# Copiar .env.example
cp .env.example .env

# Editar .env
nano .env
```

**Contenido de `frontend/.env`:**
```bash
# API Backend
VITE_API_URL=http://localhost:8080

# Stripe (clave pública)
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_test_key_here

# Google Analytics (opcional)
VITE_GA_TRACKING_ID=G-XXXXXXXXXX

# Environment
VITE_APP_ENV=development
```

---

### Instalar Dependencias

```bash
# Usando npm
npm install

# O usando pnpm (más rápido)
pnpm install
```

---

### Ejecutar Frontend en Desarrollo

```bash
npm run dev

# O con pnpm
pnpm dev

# Deberías ver:
# VITE v5.x.x ready in xxx ms
# ➜ Local:   http://localhost:5173/
# ➜ Network: use --host to expose
```

**Abrir navegador:** http://localhost:5173

---

### Configurar Panel Admin

```bash
cd admin

# Copiar .env.example
cp .env.example .env

# Instalar dependencias
npm install

# Ejecutar en desarrollo (diferente puerto)
npm run dev -- --port 5174

# Abrir navegador: http://localhost:5174
```

---

## Docker y Containerización

### Iniciar Todo el Stack con Docker Compose

```bash
# Desde la raíz del proyecto
docker compose up -d

# Ver logs
docker compose logs -f

# Ver solo logs del backend
docker compose logs -f backend

# Detener todo
docker compose down

# Detener y eliminar volúmenes (CUIDADO: borra datos)
docker compose down -v
```

---

### Comandos Útiles de Docker

```bash
# Reconstruir servicios después de cambios
docker compose up -d --build

# Ver logs de un servicio específico
docker compose logs -f backend

# Ejecutar comando dentro de un contenedor
docker compose exec backend sh
docker compose exec postgres psql -U ecommerce -d ecommerce_db

# Reiniciar un servicio específico
docker compose restart backend

# Ver uso de recursos
docker stats

# Limpiar recursos no utilizados
docker system prune -a
```

---

## Variables de Entorno

### Archivo .env Principal (Raíz del Proyecto)

```bash
# Copiar ejemplo
cp .env.example .env
```

**Contenido:**
```bash
# ===================
# DOCKER COMPOSE
# ===================
COMPOSE_PROJECT_NAME=KronosTech

# ===================
# POSTGRES
# ===================
POSTGRES_USER=ecommerce
POSTGRES_PASSWORD=dev_password_123
POSTGRES_DB=ecommerce_db
POSTGRES_PORT=5432

# ===================
# REDIS
# ===================
REDIS_PORT=6379

# ===================
# MINIO
# ===================
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
MINIO_PORT=9000
MINIO_CONSOLE_PORT=9001

# ===================
# APPLICATION PORTS
# ===================
FRONTEND_PORT=5173
ADMIN_PORT=5174
BACKEND_PORT=8080
NGINX_PORT=80
```

---

### Jerarquía de Variables de Entorno

```
.env                    # Variables globales (Docker Compose)
backend/.env            # Variables del backend
frontend/.env           # Variables del frontend
admin/.env              # Variables del panel admin
```

**IMPORTANTE:** Nunca commitear archivos `.env` al repositorio. Están en `.gitignore`.

---

## Troubleshooting

### Problemas Comunes

#### Problema: Puerto ya en uso

**Error:**
```
Error starting userland proxy: listen tcp4 0.0.0.0:5432: bind: address already in use
```

**Solución:**
```bash
# Encontrar proceso usando el puerto
sudo lsof -i :5432

# Matar proceso
sudo kill -9 <PID>

# O cambiar puerto en docker-compose.yml
ports:
  - "5433:5432"  # Usar puerto 5433 en host
```

---

#### Problema: Frontend no conecta con Backend

**Error en navegador:**
```
Failed to fetch
```

**Solución:**
```bash
# Verificar que backend está corriendo
curl http://localhost:8080/health

# Verificar CORS en backend/.env
CORS_ORIGINS=http://localhost:5173,http://localhost:5174

# Verificar VITE_API_URL en frontend/.env
VITE_API_URL=http://localhost:8080

# Reiniciar frontend
npm run dev
```

---

#### Problema: Dependencias de Rust no compilan

**Error:**
```
error: linking with `cc` failed
```

**Solución Linux:**
```bash
# Instalar build essentials
sudo apt-get update
sudo apt-get install build-essential pkg-config libssl-dev

# Limpiar y reconstruir
cargo clean
cargo build
```

**Solución macOS:**
```bash
# Instalar Xcode Command Line Tools
xcode-select --install

# Reinstalar Rust
rustup update
cargo clean
cargo build
```

---

#### Problema: npm install falla

**Error:**
```
npm ERR! code EINTEGRITY
```

**Solución:**
```bash
# Limpiar cache de npm
npm cache clean --force

# Eliminar node_modules y package-lock.json
rm -rf node_modules package-lock.json

# Reinstalar
npm install
```

---

## Recursos Adicionales

- **Documentación de Rust:** https://doc.rust-lang.org/book/
- **Documentación de SvelteKit:** https://kit.svelte.dev/docs
- **Documentación de PostgreSQL:** https://www.postgresql.org/docs/
- **Documentación de Docker:** https://docs.docker.com/
- **Documentación de Stripe:** https://stripe.com/docs

---